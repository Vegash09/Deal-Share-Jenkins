// ======================== SIMPLE DATABRICKS BUNDLE PIPELINE ========================
pipeline {
    agent {
        label 'master'  // Change to your Jenkins agent label
    }
    
    options {
        timeout(time: 2, unit: 'HOURS')
    }

    // ============== Parameters ==============
    parameters {
        booleanParam(
            name: 'VALIDATE',
            defaultValue: true,
            description: 'Validate Databricks bundle'
        )
        booleanParam(
            name: 'DEPLOY',
            defaultValue: false,
            description: 'Deploy Databricks bundle to production'
        )
    }

    // ============== Environment Variables ==============
    environment {
        // Databricks Configuration
        DATABRICKS_HOST = 'https://adb-7405617499680447.7.azuredatabricks.net/'  // Replace with your workspace URL
        DATABRICKS_CLIENT_ID = credentials('databricks-client-id')
        DATABRICKS_CLIENT_SECRET = credentials('databricks-client-secret')
        
        // Add user's local bin to PATH for databricks CLI
        PATH = "${env.HOME}/.local/bin:${env.PATH}"
    }

    stages {
        
        // ============== STAGE 1: Install Databricks CLI ==============
        stage('Install Databricks CLI') {
            steps {
                sh '''
                    echo "Checking for Databricks CLI..."
                    if ! command -v databricks &> /dev/null; then
                        echo "Installing Databricks CLI..."
                        pip3 install databricks-cli --user
                        echo "✅ Databricks CLI installed successfully!"
                    else
                        echo "✅ Databricks CLI already installed"
                        databricks --version
                    fi
                '''
            }
        }
        
        // ============== STAGE 2: Checkout Code ==============
        stage('Checkout Code') {
            steps {
                checkout scm
                sh 'ls -la'
            }
        }

        // ============== STAGE 2: Generate databricks.yml ==============
        stage('Generate Config') {
            steps {
                script {
                    sh '''
                        cat > databricks.yml << 'EOF'
bundle:
  name: databricks_asset_bundle
include:
  - dbx/**/*.yml
  - variables/prod/*.yml
  - variables/common/*.yml
permissions:
  - level: CAN_VIEW
    group_name: I_EXT_DBX_PCUBE_UCMEMBER_GMS
targets:
  env:
    mode: production
    workspace:
      host: ${DATABRICKS_HOST}
      auth_type: oauth-m2m
      client_id: ${DATABRICKS_CLIENT_ID}
      client_secret: ${DATABRICKS_CLIENT_SECRET}
      root_path: /Workspace/Repos/Deal-Share-Jenkins/dabs
    sync:
      include:
        - dbx
      exclude:
        - "Jenkinsfile"
        - "variables/**"
        - "databricks.yml"
        - "README.md"
EOF
                        echo "Generated databricks.yml:"
                        cat databricks.yml
                    '''
                }
            }
        }

        // ============== STAGE 3: Convert Python to Notebooks ==============
        stage('Convert Python Files') {
            steps {
                sh '''
                    find . -type f -name "*.py" | while read file; do
                        if ! grep -q "^# Databricks notebook source" "$file"; then
                            echo "# Databricks notebook source" | cat - "$file" > temp && mv temp "$file"
                            echo "Converted: $file"
                        fi
                    done
                '''
            }
        }

        // ============== STAGE 4: Validate Bundle ==============
        stage('Validate Bundle') {
            when {
                expression { params.VALIDATE == true }
            }
            steps {
                sh '''
                    echo "Validating Databricks bundle..."
                    databricks bundle validate
                    echo "✅ Validation successful!"
                '''
            }
        }

        // ============== STAGE 5: Plan Bundle ==============
        stage('Plan Bundle') {
            when {
                expression { params.VALIDATE == true || params.DEPLOY == true }
            }
            steps {
                sh '''
                    echo "Planning Databricks bundle..."
                    databricks bundle plan -t env
                    echo "Plan completed!"
                '''
            }
        }

        // ============== STAGE 6: Approval ==============
        stage('Approval') {
            when {
                expression { params.DEPLOY == true }
            }
            steps {
                input(
                    message: '⚠️ Deploy to Production?',
                    ok: 'Deploy',
                    submitter: 'vegash.p@diggibyte.com'  // Change to your approver emails
                )
            }
        }

        // ============== STAGE 7: Deploy Bundle ==============
        stage('Deploy Bundle') {
            when {
                expression { params.DEPLOY == true }
            }
            steps {
                sh '''
                    echo "Deploying Databricks bundle to production..."
                    databricks bundle deploy -t env
                    echo "✅ Deployment successful!"
                '''
            }
        }
    }

    // ============== Post Actions ==============
    post {
        success {
            echo '✅ Pipeline completed successfully!'
        }
        failure {
            echo '❌ Pipeline failed!'
        }
        always {
            cleanWs()
        }
    }
}
